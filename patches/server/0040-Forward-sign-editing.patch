From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PureGero <puregero@gmail.com>
Date: Mon, 13 Dec 2021 22:55:54 +1000
Subject: [PATCH] Forward sign editing


diff --git a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
index 13796495062d11f8e9fc51504d19e66f6722d701..772a9184b045e1ad900fb66bca21c2c7ed2d6188 100644
--- a/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
+++ b/src/main/java/net/minecraft/server/network/ServerGamePacketListenerImpl.java
@@ -247,6 +247,7 @@ import puregero.multipaper.MultiPaperAckBlockChangesHandler;
 import puregero.multipaper.MultiPaperEntityInteractHandler;
 import puregero.multipaper.MultiPaperInventoryHandler;
 import puregero.multipaper.MultiPaperPlayerHandler;
+import puregero.multipaper.MultiPaperSignHandler;
 import puregero.multipaper.externalserverprotocol.PlayerActionPacket;
 import puregero.multipaper.externalserverprotocol.PlayerRemovePacket;
 // CraftBukkit end
@@ -3466,6 +3467,7 @@ public class ServerGamePacketListenerImpl extends ServerCommonPacketListenerImpl
 
     @Override
     public void handleSignUpdate(ServerboundSignUpdatePacket packet) {
+        if (MultiPaperSignHandler.handleSignUpdate(this.player, packet)) return;
         // Paper start - Limit client sign length
         String[] lines = packet.getLines();
         for (int i = 0; i < lines.length; ++i) {
diff --git a/src/main/java/puregero/multipaper/MultiPaperSignHandler.java b/src/main/java/puregero/multipaper/MultiPaperSignHandler.java
new file mode 100644
index 0000000000000000000000000000000000000000..fff92fe4ed09b557e5f5cb4fe8affd3a7506f2d3
--- /dev/null
+++ b/src/main/java/puregero/multipaper/MultiPaperSignHandler.java
@@ -0,0 +1,21 @@
+package puregero.multipaper;
+
+import io.papermc.paper.chunk.system.scheduling.NewChunkHolder;
+import net.minecraft.network.protocol.game.ServerboundSignUpdatePacket;
+import net.minecraft.server.level.ServerPlayer;
+import puregero.multipaper.externalserverprotocol.PlayerActionPacket;
+
+public class MultiPaperSignHandler {
+
+    /**
+     * Returns true if the sign update should be cancelled
+     */
+    public static boolean handleSignUpdate(ServerPlayer player, ServerboundSignUpdatePacket packet) {
+        NewChunkHolder newChunkHolder = MultiPaper.getChunkHolder(player);
+        if (MultiPaper.isChunkExternal(newChunkHolder)) {
+            newChunkHolder.externalOwner.getConnection().send(new PlayerActionPacket(player, packet));
+            return true;
+        }
+        return false;
+    }
+}
\ No newline at end of file
