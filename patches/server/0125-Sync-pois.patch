From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PureGero <puregero@gmail.com>
Date: Thu, 7 Jul 2022 22:36:29 +1000
Subject: [PATCH] Sync pois


diff --git a/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiManager.java b/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiManager.java
index b827a8f3b101be7a4183634b85a381e8141a1ecb..87bb7cd16d008d1fb5246aff35a86ef3beabfc62 100644
--- a/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiManager.java
+++ b/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiManager.java
@@ -35,6 +35,7 @@ import net.minecraft.world.level.chunk.ChunkStatus;
 import net.minecraft.world.level.chunk.LevelChunkSection;
 import net.minecraft.world.level.chunk.storage.SectionStorage;
 import puregero.multipaper.MultiPaper;
+import puregero.multipaper.externalserverprotocol.SetPoiPacket;
 
 public class PoiManager extends SectionStorage<PoiSection> {
     public static final int MAX_VILLAGE_DISTANCE = 6;
@@ -65,10 +66,12 @@ public class PoiManager extends SectionStorage<PoiSection> {
 
     public void add(BlockPos pos, Holder<PoiType> type) {
         this.getOrCreate(SectionPos.asLong(pos)).add(pos, type);
+        SetPoiPacket.broadcastUpdate(world, pos); // MultiPaper
     }
 
     public void remove(BlockPos pos) {
         this.getOrLoad(SectionPos.asLong(pos)).ifPresent(poiSet -> poiSet.remove(pos));
+        SetPoiPacket.broadcastUpdate(world, pos); // MultiPaper
     }
 
     public long getCountInRange(Predicate<Holder<PoiType>> typePredicate, BlockPos pos, int radius, PoiManager.Occupancy occupationStatus) {
@@ -166,8 +169,9 @@ public class PoiManager extends SectionStorage<PoiSection> {
             // Paper end - re-route to faster logic
             .map(poi -> {
                 poi.acquireTicket();
-                return poi.getPos();
-            });
+                SetPoiPacket.broadcastUpdate(world, poi.getPos()); // MultiPaper
+            return poi.getPos();
+        });
     }
 
     public Optional<BlockPos> getRandom(
@@ -196,9 +200,13 @@ public class PoiManager extends SectionStorage<PoiSection> {
     }
 
     public boolean release(BlockPos pos) {
-        return this.getOrLoad(SectionPos.asLong(pos))
-            .map(poiSet -> poiSet.release(pos))
-            .orElseThrow(() -> Util.pauseInIde(new IllegalStateException("POI never registered at " + pos)));
+        boolean result = this.getOrLoad(SectionPos.asLong(pos)).map((poiSet) -> { // MultiPaper - add temp "result" variable
+            return poiSet.release(pos);
+        }).orElseThrow(() -> {
+            return Util.pauseInIde(new IllegalStateException("POI never registered at " + pos));
+        });
+        SetPoiPacket.broadcastUpdate(world, pos); // MultiPaper
+        return result; // MultiPaper - add temp "result" variable
     }
 
     public boolean exists(BlockPos pos, Predicate<Holder<PoiType>> predicate) {
@@ -236,6 +244,7 @@ public class PoiManager extends SectionStorage<PoiSection> {
 
     @Override
     public void setDirty(long pos) {
+        if (!SetPoiPacket.shouldSavePoi()) return; // MultiPaper - don't save if modified by another server
         // Paper start - rewrite chunk system
         int chunkX = io.papermc.paper.util.CoordinateUtils.getChunkSectionX(pos);
         int chunkZ = io.papermc.paper.util.CoordinateUtils.getChunkSectionZ(pos);
@@ -292,7 +301,7 @@ public class PoiManager extends SectionStorage<PoiSection> {
     }
 
     @Override
-    protected PoiSection getOrCreate(long pos) {
+    public PoiSection getOrCreate(long pos) { // MultiPaper - make public
         int chunkX = io.papermc.paper.util.CoordinateUtils.getChunkSectionX(pos);
         int chunkY = io.papermc.paper.util.CoordinateUtils.getChunkSectionY(pos);
         int chunkZ = io.papermc.paper.util.CoordinateUtils.getChunkSectionZ(pos);
diff --git a/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiRecord.java b/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiRecord.java
index 1673ee9f6cb7bdff48bb2ab2caa3c73755dd56a6..16f6c8712a318981cb594598c5e54aec64f63530 100644
--- a/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiRecord.java
+++ b/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiRecord.java
@@ -44,6 +44,12 @@ public class PoiRecord {
         return this.freeTickets;
     }
 
+    // MultiPaper start
+    public void setFreeTickets(int freeTickets) {
+        this.freeTickets = freeTickets;
+    }
+    // MultiPaper end
+
     protected boolean acquireTicket() {
         if (this.freeTickets <= 0) {
             return false;
diff --git a/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiSection.java b/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiSection.java
index 94404922304cfe23ea5fe8524387bc9b675cbc78..7cddb8b1c8d2ddb7412bc17b1150e9a175399db6 100644
--- a/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiSection.java
+++ b/src/main/java/net/minecraft/world/entity/ai/village/poi/PoiSection.java
@@ -129,7 +129,7 @@ public class PoiSection {
         return this.getPoiRecord(pos).map(PoiRecord::getPoiType);
     }
 
-    private Optional<PoiRecord> getPoiRecord(BlockPos pos) {
+    public Optional<PoiRecord> getPoiRecord(BlockPos pos) { // MultiPaper - make public
         return Optional.ofNullable(this.records.get(SectionPos.sectionRelativePos(pos)));
     }
 
diff --git a/src/main/java/net/minecraft/world/level/chunk/storage/SectionStorage.java b/src/main/java/net/minecraft/world/level/chunk/storage/SectionStorage.java
index 4ac5024936987c15f927e3148af4bfa57228ad1e..5797d57df90746f0c214adb670b278ea01483c79 100644
--- a/src/main/java/net/minecraft/world/level/chunk/storage/SectionStorage.java
+++ b/src/main/java/net/minecraft/world/level/chunk/storage/SectionStorage.java
@@ -107,7 +107,7 @@ public class SectionStorage<R> extends RegionFileStorage implements AutoCloseabl
         return this.levelHeightAccessor.isOutsideBuildHeight(i);
     }
 
-    protected R getOrCreate(long pos) {
+    public R getOrCreate(long pos) { // MultiPaper - make public
         if (this.outsideStoredRange(pos)) {
             throw (IllegalArgumentException)Util.pauseInIde(new IllegalArgumentException("sectionPos out of bounds"));
         } else {
diff --git a/src/main/java/puregero/multipaper/externalserverprotocol/ExternalServerPacketSerializer.java b/src/main/java/puregero/multipaper/externalserverprotocol/ExternalServerPacketSerializer.java
index 660937262481e759233bd4983f72a25edb40a8b3..daa986af84401ab6b454054973d50c1cd59853ad 100644
--- a/src/main/java/puregero/multipaper/externalserverprotocol/ExternalServerPacketSerializer.java
+++ b/src/main/java/puregero/multipaper/externalserverprotocol/ExternalServerPacketSerializer.java
@@ -75,6 +75,7 @@ public class ExternalServerPacketSerializer {
         addPacket(PlayerUseBlockPacket.class, PlayerUseBlockPacket::new);
         addPacket(RaidUpdatePacket.class, RaidUpdatePacket::new);
         addPacket(RaidJoinPacket.class, RaidJoinPacket::new);
+        addPacket(SetPoiPacket.class, SetPoiPacket::new);
     }
 
     private static void addPacket(Class<? extends ExternalServerPacket> clazz, Function<FriendlyByteBuf, ExternalServerPacket> deserializer) {
diff --git a/src/main/java/puregero/multipaper/externalserverprotocol/SetPoiPacket.java b/src/main/java/puregero/multipaper/externalserverprotocol/SetPoiPacket.java
new file mode 100644
index 0000000000000000000000000000000000000000..22235e29d5de0e789447c587ec2419adbacb8654
--- /dev/null
+++ b/src/main/java/puregero/multipaper/externalserverprotocol/SetPoiPacket.java
@@ -0,0 +1,101 @@
+package puregero.multipaper.externalserverprotocol;
+
+import io.papermc.paper.chunk.system.scheduling.NewChunkHolder;
+import net.minecraft.core.BlockPos;
+import net.minecraft.core.Holder;
+import net.minecraft.core.SectionPos;
+import net.minecraft.core.registries.BuiltInRegistries;
+import net.minecraft.network.FriendlyByteBuf;
+import net.minecraft.resources.ResourceKey;
+import net.minecraft.server.level.ServerLevel;
+import net.minecraft.world.entity.ai.village.poi.PoiManager;
+import net.minecraft.world.entity.ai.village.poi.PoiRecord;
+import net.minecraft.world.entity.ai.village.poi.PoiSection;
+import net.minecraft.world.entity.ai.village.poi.PoiType;
+import org.apache.logging.log4j.LogManager;
+import org.apache.logging.log4j.Logger;
+import org.bukkit.Bukkit;
+import org.bukkit.World;
+import org.bukkit.craftbukkit.CraftWorld;
+import puregero.multipaper.ExternalServerConnection;
+import puregero.multipaper.MultiPaper;
+
+import java.util.Optional;
+import java.util.UUID;
+
+public class SetPoiPacket extends ExternalServerPacket {
+    private static final Logger LOGGER = LogManager.getLogger(SetPoiPacket.class.getSimpleName());
+
+    private static boolean handlingPacket = false;
+    private final UUID world;
+    private final BlockPos pos;
+    private final Optional<ResourceKey<PoiType>> optionalKey;
+    private final int freeTickets;
+
+    public SetPoiPacket(ServerLevel level, BlockPos pos, Optional<Holder<PoiType>> holderOptional, int freeTickets) {
+        this.world = level.getWorld().getUID();
+        this.pos = pos;
+        this.optionalKey = holderOptional.map(Holder::unwrapKey).flatMap(optional -> optional);
+        this.freeTickets = freeTickets;
+    }
+
+    public static void broadcastUpdate(ServerLevel level, BlockPos pos) {
+        if (!handlingPacket) {
+            NewChunkHolder newChunkHolder = MultiPaper.getChunkHolder(level, pos);
+            if (newChunkHolder != null) {
+                Optional<PoiSection> poiSectionOptional = Optional.ofNullable(level.getPoiManager().get(SectionPos.asLong(pos))).flatMap(optional -> optional);
+                poiSectionOptional.ifPresent(poiSection -> {
+                    poiSection.getPoiRecord(pos).ifPresentOrElse(poiRecord -> {
+                        MultiPaper.broadcastPacketToExternalServers(newChunkHolder.externalSubscribers, () -> new SetPoiPacket(level, pos, Optional.of(poiRecord.getPoiType()), poiRecord.getFreeTickets()));
+                    }, () -> {
+                        MultiPaper.broadcastPacketToExternalServers(newChunkHolder.externalSubscribers, () -> new SetPoiPacket(level, pos, Optional.empty(), 0));
+                    });
+                });
+            }
+        }
+    }
+
+    public SetPoiPacket(FriendlyByteBuf in) {
+        this.world = in.readUUID();
+        this.pos = in.readBlockPos();
+        this.optionalKey = in.readOptional(in2 -> in2.readResourceKey(BuiltInRegistries.POINT_OF_INTEREST_TYPE.key()));
+        this.freeTickets = in.readVarInt();
+    }
+
+    @Override
+    public void write(FriendlyByteBuf out) {
+        out.writeUUID(this.world);
+        out.writeBlockPos(this.pos);
+        out.writeOptional(this.optionalKey, FriendlyByteBuf::writeResourceKey);
+        out.writeVarInt(this.freeTickets);
+    }
+
+    @Override
+    public void handle(ExternalServerConnection connection) {
+        MultiPaper.runSync(() -> {
+            handlingPacket = true;
+            World world = Bukkit.getWorld(this.world);
+            if (world instanceof CraftWorld craftWorld) {
+                PoiManager poiManager = craftWorld.getHandle().getPoiManager();
+                this.optionalKey.ifPresentOrElse(key -> {
+                    PoiSection poiSection = poiManager.getOrCreate(SectionPos.asLong(pos));
+                    PoiRecord record = poiSection.getPoiRecord(pos).orElse(null);
+                    if (record == null || !record.getPoiType().is(key)) {
+                        poiManager.add(this.pos, BuiltInRegistries.POINT_OF_INTEREST_TYPE.getHolderOrThrow(key));
+                        record = poiSection.getPoiRecord(pos).orElse(null);
+                    }
+                    if (record != null) {
+                        record.setFreeTickets(freeTickets);
+                    }
+                }, () -> {
+                    poiManager.remove(this.pos);
+                });
+            }
+            handlingPacket = false;
+        });
+    }
+
+    public static boolean shouldSavePoi() {
+        return !handlingPacket;
+    }
+}
