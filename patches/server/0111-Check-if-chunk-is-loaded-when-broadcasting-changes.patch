From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: PureGero <puregero@gmail.com>
Date: Mon, 18 Apr 2022 21:46:09 +1000
Subject: [PATCH] Check if chunk is loaded when broadcasting changes


diff --git a/src/main/java/net/minecraft/server/level/ServerChunkCache.java b/src/main/java/net/minecraft/server/level/ServerChunkCache.java
index e611bba7c0e9cb4ad4e017965301f6df49eee32d..1e1ab72618159202a072543dedafde79146fddb5 100644
--- a/src/main/java/net/minecraft/server/level/ServerChunkCache.java
+++ b/src/main/java/net/minecraft/server/level/ServerChunkCache.java
@@ -672,7 +672,7 @@ public class ServerChunkCache extends ChunkSource {
                 it.unimi.dsi.fastutil.objects.ReferenceOpenHashSet<ChunkHolder> copy = this.chunkMap.needsChangeBroadcasting.clone();
                 this.chunkMap.needsChangeBroadcasting.clear();
                 for (ChunkHolder holder : copy) {
-                    holder.broadcastChanges(holder.getFullChunkNowUnchecked()); // LevelChunks are NEVER unloaded
+                    Optional.ofNullable(holder.getFullChunkNowUnchecked()).ifPresent(holder::broadcastChanges); // LevelChunks are NEVER unloaded // MultiPaper - Add null check. MultiPaper might not remove an unloaded chunk from needsChangeBroadcasting, and getFullChunkNowUnchecked may be null
                     if (holder.needsBroadcastChanges()) {
                         // I DON'T want to KNOW what DUMB plugins might be doing.
                         this.chunkMap.needsChangeBroadcasting.add(holder);
