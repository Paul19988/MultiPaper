From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Stuart Pomeroy <stuart@pomeroys.site>
Date: Sun, 26 Mar 2023 15:52:49 +0100
Subject: [PATCH] Fix ability to duplicate items enchanted in anvils

By default Paper makes a change that automatically sorts the enchantments on an item when enchanted or parsed from NBT. This change did not account for enchanting items through an Anvil.

diff --git a/src/main/java/net/minecraft/world/item/ItemStack.java b/src/main/java/net/minecraft/world/item/ItemStack.java
index c20f33284174473cc56c5eb144da759916c97ca3..318531165a99a1f2a11af97c7b83237f79c62350 100644
--- a/src/main/java/net/minecraft/world/item/ItemStack.java
+++ b/src/main/java/net/minecraft/world/item/ItemStack.java
@@ -1276,6 +1276,7 @@ public final class ItemStack {
     public void addTagElement(String key, Tag element) {
         this.getOrCreateTag().put(key, element);
 
+        if(key.equals("Enchantments")) processEnchantOrder(this.getOrCreateTag()); // MultiPaper - Reorder enchantments to prevent desync.
         markDirty(); // MultiPaper
     }
 
